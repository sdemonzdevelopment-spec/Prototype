name: Build Ren'Py Android APK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

# FIX 1: Grant permission to upload releases (Solves the 403 error)
permissions:
  contents: write

env:
  RENPY_VERSION: "8.1.3"
  ANDROID_API: "30"
  BUILD_TOOLS: "30.0.3"
  NDK_VERSION: "21.3.6528147"
  JAVA_VERSION: "17"

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libncurses6 libncurses-dev libz-dev xz-utils
          sudo ln -s /lib/x86_64-linux-gnu/libncurses.so.6 /usr/lib/x86_64-linux-gnu/libncurses.so.5 || true
        shell: bash

      - name: Clean old artifacts
        run: |
          rm -rf renpy-sdk* rapt* build-output* || true
        shell: bash

      - name: Download and extract Ren'Py SDK
        run: |
          set -euo pipefail
          RENPY_VER="${{ env.RENPY_VERSION }}"
          RENPY_URL="https://www.renpy.org/dl/${RENPY_VER}/renpy-${RENPY_VER}-sdk.tar.bz2"
          
          echo "Downloading Ren'Py SDK ${RENPY_VER}..."
          wget -q --show-progress -O renpy-sdk.tar.bz2 "$RENPY_URL"
          tar xf renpy-sdk.tar.bz2
          
          RENPY_DIR=$(ls -d renpy-* 2>/dev/null | head -1)
          mv "$RENPY_DIR" renpy-sdk
          echo "RENPY_ROOT=$(pwd)/renpy-sdk" >> $GITHUB_ENV
        shell: bash

      - name: Download and install RAPT
        run: |
          set -euo pipefail
          RENPY_VER="${{ env.RENPY_VERSION }}"
          RAPT_URL="https://www.renpy.org/dl/${RENPY_VER}/renpy-${RENPY_VER}-rapt.zip"
          
          echo "Downloading RAPT ${RENPY_VER}..."
          wget -q --show-progress -O rapt.zip "$RAPT_URL"
          unzip -q rapt.zip
          
          # Robustly find where build.py is hidden and move it to the right place
          RAPT_SOURCE=$(find . -type f -name "build.py" | head -1 | xargs dirname)
          echo "Found RAPT source at: $RAPT_SOURCE"
          
          rm -rf renpy-sdk/rapt
          mv "$RAPT_SOURCE" renpy-sdk/rapt
        shell: bash

      - name: Setup Android SDK
        run: |
          set -euo pipefail
          ANDROID_SDK_ROOT="$HOME/android-sdk"
          
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT/cmdline-tools"
          
          echo "Downloading Android command-line tools..."
          wget -q --show-progress -O cmdline-tools.zip "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
          unzip -q cmdline-tools.zip
          mv cmdline-tools latest
          
          SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          chmod +x "$SDKMANAGER"
          
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          
          yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" --licenses 2>/dev/null || true
          
          "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "platforms;android-${{ env.ANDROID_API }}" \
            "build-tools;${{ env.BUILD_TOOLS }}" \
            "ndk;${{ env.NDK_VERSION }}" 2>&1 | tail -10 || true
        shell: bash

      - name: Configure RAPT
        run: |
          set -euo pipefail
          RENPY_ROOT="${{ env.RENPY_ROOT }}"
          echo "${{ env.ANDROID_SDK_ROOT }}" > "$RENPY_ROOT/rapt/sdk.txt"
        shell: bash

      - name: Prepare game files
        run: |
          set -euo pipefail
          RENPY_ROOT="${{ env.RENPY_ROOT }}"
          rm -rf "$RENPY_ROOT/game"
          cp -r game "$RENPY_ROOT/game"
        shell: bash

      - name: Build Android APK
        run: |
          set -euo pipefail
          
          # 1. DEFINE PATHS
          RENPY_ROOT="${{ env.RENPY_ROOT }}"
          GAME_DIR="$(pwd)/game"
          RAPT_DIR="$RENPY_ROOT/rapt"
          
          echo "Finding bundled Python..."
          # Find the python executable inside the SDK (linux-x86_64)
          RENPY_PY=$(find "$RENPY_ROOT/lib" -name "python" -type f -executable | grep "linux-x86_64" | head -1)
          
          if [ -z "$RENPY_PY" ]; then
             echo "::error::Could not find bundled Python in Ren'Py SDK"
             exit 1
          fi
          echo "Using bundled Python at: $RENPY_PY"

          # 2. ENVIRONMENT SETUP (Crucial for 'import renpy')
          # PYTHONPATH must be the SDK Root so python can find the 'renpy' folder
          export PYTHONPATH="$RENPY_ROOT"
          
          # LD_LIBRARY_PATH allows python to find its own compiled libraries
          export LD_LIBRARY_PATH="$(dirname "$RENPY_PY")"
          
          echo "PYTHONPATH is set to: $PYTHONPATH"
          
          # 3. EXECUTE BUILD
          cd "$RAPT_DIR"
          
          "$RENPY_PY" build.py release \
            "$GAME_DIR" \
            com.demonz.development.demo \
            "DemonZ Prototype" \
            --version "1.0.0" \
            --numeric-version 1 \
            --orientation landscape
          
          echo "âœ“ Build completed"
        shell: bash

      - name: Find and organize APK
        run: |
          set -euo pipefail
          RENPY_ROOT="${{ env.RENPY_ROOT }}"
          OUTPUT_DIR="build-output"
          mkdir -p "$OUTPUT_DIR"
          
          find "$RENPY_ROOT/rapt" -type f -name "*.apk" -exec cp {} "$OUTPUT_DIR/" \;
          find "$RENPY_ROOT/rapt" -type f -name "*.aab" -exec cp {} "$OUTPUT_DIR/" \;
          
          if [ -n "$(ls -A "$OUTPUT_DIR" 2>/dev/null)" ]; then
            ls -lh "$OUTPUT_DIR"
          else
            echo "::error::No APK/AAB files found in output"
            exit 1
          fi
          
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
        shell: bash

      - name: Upload APK to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DemonZ-APK-${{ github.run_number }}
          path: build-output/
          if-no-files-found: warn
          retention-days: 30

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: android-build-${{ github.run_number }}
          name: DemonZ Android Build ${{ github.run_number }}
          draft: false
          prerelease: false
          files: build-output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}