name: Build & Sign Ren'Py Android

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RENPY_VERSION: '8.2.6'        # change if needed
  ANDROID_PLATFORM: 'android-33'
  BUILD_TOOLS: '33.0.2'
  NDK_VERSION: '21.3.6528147'

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Show workflow & runner info (debug)
        run: |
          echo "GITHUB_WORKFLOW: $GITHUB_WORKFLOW"
          echo "GITHUB_REF: $GITHUB_REF"
          echo "RUNNER_TEMP: $RUNNER_TEMP"
          echo "RUNNER_WORKSPACE: $RUNNER_WORKSPACE"
          pwd
          ls -la
          echo "Listing .github/workflows"
          ls -la .github/workflows || true
        shell: bash

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Prepare ANDROID_SDK_ROOT and install Android SDK command-line tools
        run: |
          set -e
          # Use runner temp directory for SDK to avoid runner.* expressions in env
          export ANDROID_SDK_ROOT="$RUNNER_TEMP/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT/cmdline-tools"
          echo "Downloading Android command line tools..."
          curl -sSLo commandlinetools.zip https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip
          unzip -qq commandlinetools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
          yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;${ANDROID_PLATFORM}" "build-tools;${BUILD_TOOLS}" "ndk;${NDK_VERSION}"
          echo "ANDROID_SDK_ROOT is $ANDROID_SDK_ROOT"
          # Persist path for later steps by writing to GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        shell: bash

      - name: Add Android SDK tools to PATH
        run: |
          echo "$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/build-tools/${BUILD_TOOLS}" >> $GITHUB_PATH
          echo "PATH now includes Android tools"
        shell: bash

      - name: Setup Ren'Py CLI
        uses: remarkablegames/setup-renpy@v1
        with:
          renpy-version: ${{ env.RENPY_VERSION }}

      - name: Show versions (sanity)
        run: |
          java -version
          sdkmanager --version || true
          adb --version || true
          renpy-cli --version || true
        shell: bash

      - name: Prepare keystore (optional; base64)
        if: ${{ secrets.RENPY_KEYSTORE_BASE64 != '' }}
        run: |
          echo "${{ secrets.RENPY_KEYSTORE_BASE64 }}" | base64 -d > ./release-keystore.jks
          ls -l ./release-keystore.jks
        shell: bash

      - name: Print workspace before build (debug)
        run: |
          echo "Workspace files (top-level):"
          ls -la
          echo "Contents of game/ (if present):"
          ls -la game || true
        shell: bash

      - name: Run Ren'Py Android build
        run: |
          set -e
          # ANDROID_SDK_ROOT is available through $ANDROID_SDK_ROOT from GITHUB_ENV
          echo "Using ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo "Starting Ren'Py packaging..."
          # Adjust the path ./game if your project lives under a different folder
          renpy-cli ./renpy --package android ./game || (echo "Ren'Py packaging failed" && exit 1)
        shell: bash

      - name: Locate APK/AAB outputs
        run: |
          echo "Looking for APK/AAB files..."
          find . -type f \( -iname "*.apk" -o -iname "*.aab" \) -maxdepth 8 -print || true
        shell: bash

      - name: Zipalign & Sign APKs (if keystore provided)
        if: ${{ secrets.RENPY_KEYSTORE_BASE64 != '' }}
        run: |
          set -e
          APKS=$(find . -type f -iname "*.apk" -print || true)
          if [ -z "$APKS" ]; then
            echo "No APKs found to sign."
            exit 0
          fi
          for apk in $APKS; do
            echo "Processing $apk"
            aligned="${apk%.apk}-aligned.apk"
            signed="${apk%.apk}-signed.apk"
            # zipalign
            "$ANDROID_SDK_ROOT/build-tools/${BUILD_TOOLS}/zipalign" -v -p 4 "$apk" "$aligned"
            # apksigner sign
            "$ANDROID_SDK_ROOT/build-tools/${BUILD_TOOLS}/apksigner" sign \
              --ks ./release-keystore.jks \
              --ks-pass pass:${{ secrets.RENPY_KEYSTORE_PASSWORD }} \
              --key-pass pass:${{ secrets.RENPY_KEY_PASSWORD }} \
              --out "$signed" "$aligned"
            echo "Signed: $signed"
          done
        shell: bash

      - name: Upload built artifacts
        uses: actions/upload-artifact@v4
        with:
          name: renpy-android-build
          path: |
            **/*-signed.apk
            **/*.apk
            **/*.aab

      - name: Cleanup keystore
        if: ${{ secrets.RENPY_KEYSTORE_BASE64 != '' }}
        run: |
          shred -u ./release-keystore.jks || rm -f ./release-keystore.jks
        shell: bash
