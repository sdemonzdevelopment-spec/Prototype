name: Build RenPy Android

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  RENPY_VERSION: "8.2.6"
  ANDROID_PLATFORM: "android-33"
  BUILD_TOOLS: "33.0.2"
  NDK_VERSION: "21.3.6528147"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17 (required for latest sdkmanager)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Verify Java is 17
        run: java -version

      - name: Install Android SDK + NDK (2024-safe)
        run: |
          set -e
          export ANDROID_SDK_ROOT="$RUNNER_TEMP/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT/cmdline-tools"
          echo "Downloading latest cmdline-tools..."
          curl -o tools.zip -L https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip tools.zip -d ./tmp
          mv ./tmp/cmdline-tools ./latest
          echo "Installed cmdline-tools structure:"
          ls -R .
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
          yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "platforms;${ANDROID_PLATFORM}" \
            "build-tools;${BUILD_TOOLS}" \
            "ndk;${NDK_VERSION}"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV

      - name: Setup RenPy
        uses: remarkablegames/setup-renpy@v1
        with:
          renpy-version: ${{ env.RENPY_VERSION }}

      - name: Verify tools
        run: |
          java -version
          renpy-cli --version || true
          adb --version || true
          ls -la

      - name: Build APK
        run: |
          set -e
          echo "Building Android package..."
          renpy-cli ./renpy --package android ./game

      - name: Find and upload APK
        uses: actions/upload-artifact@v4
        with:
          name: renpy-apk
          path: "**/*.apk"
