name: Build Ren'Py Android APK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  RENPY_VERSION: "8.1.3"
  ANDROID_API: "30"
  BUILD_TOOLS: "30.0.3"
  NDK_VERSION: "21.3.6528147"
  JAVA_VERSION: "17"

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libncurses6 libncurses-dev libz-dev xz-utils
          sudo ln -s /lib/x86_64-linux-gnu/libncurses.so.6 /usr/lib/x86_64-linux-gnu/libncurses.so.5 || true
        shell: bash

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools wheel pyyaml
        shell: bash

      - name: Clean old artifacts
        run: |
          rm -rf renpy-sdk* rapt* build-output* android-build* || true
        shell: bash

      - name: Download and extract Ren'Py SDK
        run: |
          set -euo pipefail
          RENPY_VER="${{ env.RENPY_VERSION }}"
          RENPY_URL="https://www.renpy.org/dl/${RENPY_VER}/renpy-${RENPY_VER}-sdk.tar.bz2"
          
          echo "Downloading Ren'Py SDK ${RENPY_VER}..."
          wget -q --show-progress -O renpy-sdk.tar.bz2 "$RENPY_URL"
          tar xf renpy-sdk.tar.bz2
          
          RENPY_DIR=$(ls -d renpy-* 2>/dev/null | head -1)
          if [ -z "$RENPY_DIR" ]; then
            echo "::error::Ren'Py SDK extraction failed"
            exit 1
          fi
          
          mv "$RENPY_DIR" renpy-sdk
          echo "RENPY_ROOT=$(pwd)/renpy-sdk" >> $GITHUB_ENV
        shell: bash

      - name: Download and install RAPT
        run: |
          set -euo pipefail
          RENPY_VER="${{ env.RENPY_VERSION }}"
          RAPT_URL="https://www.renpy.org/dl/${RENPY_VER}/renpy-${RENPY_VER}-rapt.zip"
          
          echo "Downloading RAPT ${RENPY_VER}..."
          wget -q --show-progress -O rapt.zip "$RAPT_URL"
          unzip -q rapt.zip
          
          if [ -d "rapt" ]; then
            RAPT_DIR="rapt"
          else
            RAPT_DIR=$(find . -maxdepth 1 -type d -name "rapt*" | head -1)
          fi
          
          if [ -z "$RAPT_DIR" ]; then
            echo "::error::RAPT not found"
            exit 1
          fi
          
          rm -rf renpy-sdk/rapt
          mv "$RAPT_DIR" renpy-sdk/rapt
        shell: bash

      - name: Setup Android SDK
        run: |
          set -euo pipefail
          ANDROID_SDK_ROOT="$HOME/android-sdk"
          
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT/cmdline-tools"
          
          echo "Downloading Android command-line tools..."
          wget -q --show-progress -O cmdline-tools.zip "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
          
          echo "Extracting Android tools..."
          unzip -q cmdline-tools.zip
          mv cmdline-tools latest
          
          SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          chmod +x "$SDKMANAGER"
          
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          
          echo "Installing Android SDK components..."
          yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" --licenses 2>/dev/null || true
          
          "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "platforms;android-${{ env.ANDROID_API }}" \
            "build-tools;${{ env.BUILD_TOOLS }}" \
            "ndk;${{ env.NDK_VERSION }}" 2>&1 | tail -10
        shell: bash

      - name: Configure RAPT
        run: |
          set -euo pipefail
          RENPY_ROOT="${{ env.RENPY_ROOT }}"
          echo "${{ env.ANDROID_SDK_ROOT }}" > "$RENPY_ROOT/rapt/sdk.txt"
        shell: bash

      - name: Verify game directory
        run: |
          if [ ! -d "game" ]; then
            echo "::error::game/ directory not found"
            exit 1
          fi
          
          if ! find game -name "*.rpy" -type f | grep -q .; then
            echo "::error::No .rpy files found in game/"
            exit 1
          fi
          
          echo "Game directory verified"
          ls -la game/
        shell: bash

      - name: Prepare game files
        run: |
          set -euo pipefail
          RENPY_ROOT="${{ env.RENPY_ROOT }}"
          
          rm -rf "$RENPY_ROOT/game"
          cp -r game "$RENPY_ROOT/game"
          
          echo "Game files prepared"
          ls -la "$RENPY_ROOT/game/"
        shell: bash

      - name: Build Android APK
        run: |
          set -euo pipefail
          
          RENPY_ROOT="${{ env.RENPY_ROOT }}"
          GAME_DIR="$(pwd)/game"
          
          echo "Starting Ren'Py Android build..."
          cd "$RENPY_ROOT"
          
          export ANDROIDSDK="${{ env.ANDROID_SDK_ROOT }}"
          export ANDROIDNDK="${{ env.ANDROID_NDK_HOME }}"
          export ANDROIDAPI="${{ env.ANDROID_API }}"
          
          python3 -u renpy.py android_build "$GAME_DIR" \
            --dest "$RENPY_ROOT/rapt/bin" \
            --package com.demonz.development.demo \
            --name "DemonZ Prototype" \
            --version "1.0.0" \
            --numeric-version 1 \
            --orientation landscape \
            release 2>&1 || {
            
            echo "Build attempt completed with code $?"
            find "$RENPY_ROOT/rapt" -type f -name "*.apk" -o -name "*.aab" 2>/dev/null | head -5 || true
          }
        shell: bash

      - name: Find and organize APK
        run: |
          set -euo pipefail
          
          RENPY_ROOT="${{ env.RENPY_ROOT }}"
          OUTPUT_DIR="build-output"
          mkdir -p "$OUTPUT_DIR"
          
          echo "Searching for build artifacts..."
          
          find "$RENPY_ROOT/rapt" -type f -name "*.apk" 2>/dev/null | head -10 | while read -r apk; do
            if [ -f "$apk" ]; then
              echo "Found APK: $apk"
              cp -v "$apk" "$OUTPUT_DIR/"
            fi
          done
          
          find "$RENPY_ROOT/rapt" -type f -name "*.aab" 2>/dev/null | head -10 | while read -r aab; do
            if [ -f "$aab" ]; then
              echo "Found AAB: $aab"
              cp -v "$aab" "$OUTPUT_DIR/"
            fi
          done
          
          echo ""
          echo "Output directory contents:"
          ls -lh "$OUTPUT_DIR" 2>/dev/null || echo "No files in output directory"
          
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
        shell: bash

      - name: Upload APK to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DemonZ-APK-Build-${{ github.run_number }}
          path: build-output/
          if-no-files-found: warn
          retention-days: 30

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: android-build-${{ github.run_number }}
          name: DemonZ Android Build ${{ github.run_number }}
          draft: false
          prerelease: false
          files: build-output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        if: always()
        run: |
          echo "========== BUILD SUMMARY =========="
          echo "Project: DemonZ Echoes of the Forgotten"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run: ${{ github.run_number }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          
          if [ -d "build-output" ] && [ -n "$(ls -A build-output 2>/dev/null)" ]; then
            echo ""
            echo "✓ Build artifacts generated:"
            ls -lh build-output/
          else
            echo ""
            echo "⚠ No artifacts found - check logs above"
          fi
          
          echo "======================================"
        shell: bash
