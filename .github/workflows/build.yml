      - name: Download and install RAPT
        id: rapt_install
        run: |
          set -euo pipefail
          RENPY_VER="${{ env.RENPY_VERSION }}"
          RAPT_URL="https://www.renpy.org/dl/${RENPY_VER}/renpy-${RENPY_VER}-rapt.zip"
          
          echo "Downloading RAPT (Ren'Py Android Packaging Tool) version ${RENPY_VER}..."
          wget -q --show-progress -O rapt-download.zip "$RAPT_URL"
          
          echo "Extracting RAPT archive..."
          rm -rf rapt-extract
          mkdir -p rapt-extract
          unzip -q rapt-download.zip -d rapt-extract
          
          echo "Analyzing RAPT archive structure..."
          echo "Full directory tree:"
          find rapt-extract -type d | head -20
          
          echo "Python files in archive:"
          find rapt-extract -type f -name "*.py" | head -20
          
          # The RAPT archive typically contains a 'rapt' directory at root after extraction
          # Look for it more carefully
          if [ -d "rapt-extract/rapt" ]; then
            RAPT_TOP_DIR="rapt-extract/rapt"
            echo "Found RAPT directory at root level: $RAPT_TOP_DIR"
          else
            # Fallback: search for it
            RAPT_TOP_DIR=$(find rapt-extract -maxdepth 2 -type d -name "rapt" -print -quit || true)
            
            if [ -z "$RAPT_TOP_DIR" ]; then
              echo "::error::Could not locate top-level RAPT directory"
              echo "Archive structure:"
              ls -la rapt-extract || true
              exit 1
            fi
            echo "Found RAPT directory at: $RAPT_TOP_DIR"
          fi
          
          if [ ! -d "renpy-sdk" ]; then
            echo "::error::Ren'Py SDK directory not found. Previous step may have failed."
            ls -la || true
            exit 1
          fi
          
          echo "Installing RAPT into Ren'Py SDK..."
          rm -rf renpy-sdk/rapt || true
          cp -r "$RAPT_TOP_DIR" renpy-sdk/rapt
          
          # Make Python scripts executable
          if [ -d "renpy-sdk/rapt" ]; then
            find renpy-sdk/rapt -type f -name "*.py" -exec chmod +x {} ;
          fi
          
          echo "RAPT installation complete. Directory structure:"
          ls -la renpy-sdk/rapt || true
          
          if [ -d "renpy-sdk/rapt/buildlib" ]; then
            echo "buildlib directory found"
            ls -la renpy-sdk/rapt/buildlib | head -20 || true
          fi
          
          RAPT_ROOT_PATH="$(pwd)/renpy-sdk/rapt"
          echo "RAPT_ROOT=$RAPT_ROOT_PATH" >> $GITHUB_ENV
          
          echo "Searching for configure.py and build.py..."
          if [ -f "renpy-sdk/rapt/configure.py" ]; then
            echo "Found configure.py at root level"
          elif find renpy-sdk/rapt -name "configure.py" -type f 2>/dev/null | grep -q .; then
            echo "Found configure.py in subdirectory"
          else
            echo "::warning::configure.py not found"
          fi
        shell: bash
