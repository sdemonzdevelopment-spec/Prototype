name: Build Ren'Py Android APK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

permissions:
  contents: write

env:
  RENPY_VERSION: "8.1.3"
  ANDROID_API: "30"
  BUILD_TOOLS: "30.0.3"
  NDK_VERSION: "21.3.6528147"
  JAVA_VERSION: "17"

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libncurses6 libncurses-dev libz-dev xz-utils
          sudo ln -s /lib/x86_64-linux-gnu/libncurses.so.6 /usr/lib/x86_64-linux-gnu/libncurses.so.5 || true
        shell: bash

      - name: Install Python dependencies
        # FIX: Added 'future', 'six', 'pefile', 'rsa', 'requests' which are required by RAPT/Ren'Py
        run: |
          python3 -m pip install --upgrade pip setuptools wheel pyyaml future six pefile rsa requests
        shell: bash

      - name: Clean old artifacts
        run: |
          rm -rf renpy-sdk* rapt* build-output* || true
        shell: bash

      - name: Download and extract Ren'Py SDK
        run: |
          set -euo pipefail
          RENPY_VER="${{ env.RENPY_VERSION }}"
          RENPY_URL="https://www.renpy.org/dl/${RENPY_VER}/renpy-${RENPY_VER}-sdk.tar.bz2"
          
          echo "Downloading Ren'Py SDK ${RENPY_VER}..."
          wget -q --show-progress -O renpy-sdk.tar.bz2 "$RENPY_URL"
          tar xf renpy-sdk.tar.bz2
          
          RENPY_DIR=$(ls -d renpy-* 2>/dev/null | head -1)
          if [ -z "$RENPY_DIR" ]; then
            echo "::error::Ren'Py SDK extraction failed"
            exit 1
          fi
          
          mv "$RENPY_DIR" renpy-sdk
          echo "RENPY_ROOT=$(pwd)/renpy-sdk" >> $GITHUB_ENV
        shell: bash

      - name: Download and install RAPT
        run: |
          set -euo pipefail
          RENPY_VER="${{ env.RENPY_VERSION }}"
          RAPT_URL="https://www.renpy.org/dl/${RENPY_VER}/renpy-${RENPY_VER}-rapt.zip"
          
          echo "Downloading RAPT ${RENPY_VER}..."
          wget -q --show-progress -O rapt.zip "$RAPT_URL"
          unzip -q rapt.zip
          
          # Find the exact directory containing build.py
          RAPT_SOURCE=$(find . -type f -name "build.py" | head -1 | xargs dirname)
          
          if [ -z "$RAPT_SOURCE" ]; then
            echo "::error::RAPT build.py not found in extracted files"
            find . -maxdepth 3
            exit 1
          fi
          
          echo "Found RAPT source at: $RAPT_SOURCE"
          rm -rf renpy-sdk/rapt
          mv "$RAPT_SOURCE" renpy-sdk/rapt
          echo "RAPT installed to renpy-sdk/rapt"
        shell: bash

      - name: Setup Android SDK
        run: |
          set -euo pipefail
          ANDROID_SDK_ROOT="$HOME/android-sdk"
          
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT/cmdline-tools"
          
          echo "Downloading Android command-line tools..."
          wget -q --show-progress -O cmdline-tools.zip "https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip"
          unzip -q cmdline-tools.zip
          mv cmdline-tools latest
          
          SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          chmod +x "$SDKMANAGER"
          
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          
          yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" --licenses 2>/dev/null || true
          
          "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "platforms;android-${{ env.ANDROID_API }}" \
            "build-tools;${{ env.BUILD_TOOLS }}" \
            "ndk;${{ env.NDK_VERSION }}" 2>&1 | tail -10 || true
        shell: bash

      - name: Configure RAPT
        run: |
          set -euo pipefail
          RENPY_ROOT="${{ env.RENPY_ROOT }}"
          echo "${{ env.ANDROID_SDK_ROOT }}" > "$RENPY_ROOT/rapt/sdk.txt"
        shell: bash

      - name: Verify game directory
        run: |
          if [ ! -d "game" ]; then
            echo "::error::game/ directory not found"
            exit 1
          fi
          
          if ! find game -name "*.rpy" -type f | grep -q .; then
            echo "::error::No .rpy files found in game/"
            exit 1
          fi
          echo "✓ Game directory verified"
        shell: bash

      - name: Prepare game files
        run: |
          set -euo pipefail
          RENPY_ROOT="${{ env.RENPY_ROOT }}"
          rm -rf "$RENPY_ROOT/game"
          cp -r game "$RENPY_ROOT/game"
          echo "✓ Game files copied to SDK"
        shell: bash

      - name: Build Android APK
        run: |
          set -euo pipefail
          
          RENPY_ROOT="${{ env.RENPY_ROOT }}"
          GAME_DIR="$(pwd)/game"
          
          echo "Starting Android APK build..."
          cd "$RENPY_ROOT/rapt"
          
          # Debug: Ensure file exists
          ls -la build.py
          
          export ANDROIDSDK="${{ env.ANDROID_SDK_ROOT }}"
          export ANDROIDNDK="${{ env.ANDROID_NDK_HOME }}"
          export ANDROIDAPI="${{ env.ANDROID_API }}"
          
          # Add RENPY_ROOT to PYTHONPATH
          export PYTHONPATH="$RENPY_ROOT:$RENPY_ROOT/rapt:${PYTHONPATH:-}"
          
          python3 build.py release \
            "$GAME_DIR" \
            com.demonz.development.demo \
            "DemonZ Prototype" \
            --version "1.0.0" \
            --numeric-version 1 \
            --orientation landscape
          
          echo "✓ Build completed"
        shell: bash

      - name: Find and organize APK
        run: |
          set -euo pipefail
          
          RENPY_ROOT="${{ env.RENPY_ROOT }}"
          OUTPUT_DIR="build-output"
          mkdir -p "$OUTPUT_DIR"
          
          echo "Searching for APK/AAB files..."
          
          find "$RENPY_ROOT/rapt" -type f -name "*.apk" 2>/dev/null | while read -r apk; do
            echo "Found APK: $apk"
            cp "$apk" "$OUTPUT_DIR/" || true
          done
          
          find "$RENPY_ROOT/rapt" -type f -name "*.aab" 2>/dev/null | while read -r aab; do
            echo "Found AAB: $aab"
            cp "$aab" "$OUTPUT_DIR/" || true
          done
          
          if [ -n "$(ls -A "$OUTPUT_DIR" 2>/dev/null)" ]; then
            echo ""
            echo "✓ Artifacts found:"
            ls -lh "$OUTPUT_DIR"
          else
            echo "::error::No APK/AAB files found in output"
            exit 1
          fi
          
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
        shell: bash

      - name: Upload APK to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DemonZ-APK-${{ github.run_number }}
          path: build-output/
          if-no-files-found: warn
          retention-days: 30

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: android-build-${{ github.run_number }}
          name: DemonZ Android Build ${{ github.run_number }}
          draft: false
          prerelease: false
          files: build-output/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}